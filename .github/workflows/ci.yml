name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-circuits:
    name: Validate Circuit Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
    - name: Validate all example circuits
      run: |
        echo "üîç Validating all .circuit.json files..."
        EXIT_CODE=0
        
        for file in examples/*.circuit.json; do
          if [ -f "$file" ]; then
            echo "Validating: $file"
            if python circuit validate "$file"; then
              echo "‚úÖ $file passed validation"
            else
              echo "‚ùå $file failed validation"
              EXIT_CODE=1
            fi
            echo ""
          fi
        done
        
        exit $EXIT_CODE
        
    - name: Display circuit info
      if: success()
      run: |
        echo "üìä Circuit Information Summary"
        for file in examples/*.circuit.json; do
          if [ -f "$file" ]; then
            echo "=== $file ==="
            python circuit info "$file"
            echo ""
          fi
        done

  test-adapters:
    name: Test Export Adapters
    runs-on: ubuntu-latest
    needs: validate-circuits
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .
        
    - name: Test Altium export
      run: |
        echo "üîß Testing Altium Designer export..."
        mkdir -p test_exports/altium
        
        for file in examples/*.circuit.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .circuit.json)
            echo "Exporting: $file to Altium format"
            python circuit export "$file" --format altium --output "test_exports/altium/$filename"
          fi
        done
        
        echo "‚úÖ Altium export test completed"
        ls -R test_exports/altium
        
    - name: Test BOM generation
      run: |
        echo "üì¶ Testing BOM generation..."
        mkdir -p test_exports/bom
        
        for file in examples/*.circuit.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" .circuit.json)
            echo "Generating BOM for: $file"
            python circuit export "$file" --format bom --output "test_exports/bom/$filename"
          fi
        done
        
        echo "‚úÖ BOM generation test completed"
        cat test_exports/bom/*/bom.csv
        
    - name: Upload export artifacts
      uses: actions/upload-artifact@v3
      with:
        name: circuit-exports
        path: test_exports/
        retention-days: 7

  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint
        
    - name: Lint with flake8
      continue-on-error: true
      run: |
        echo "üîç Running flake8..."
        flake8 cli/ adapters/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 cli/ adapters/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  validate-schema:
    name: Validate JSON Schema
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jsonschema check-jsonschema
        
    - name: Validate schema file
      run: |
        echo "üîç Validating circuit.schema.json..."
        python -c "
import json
import jsonschema
from jsonschema import Draft7Validator

with open('schema/circuit.schema.json', 'r') as f:
    schema = json.load(f)

# Check if schema itself is valid
try:
    Draft7Validator.check_schema(schema)
    print('‚úÖ Schema is valid JSON Schema Draft 7')
except Exception as e:
    print(f'‚ùå Schema validation failed: {e}')
    exit(1)
"

  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check documentation files
      run: |
        echo "üìö Checking documentation..."
        
        required_docs=(
          "README.md"
          "CONTRIBUTING.md"
          "ROADMAP.md"
          "QUICKSTART.md"
          "CODE_OF_CONDUCT.md"
          "LICENSE"
        )
        
        all_found=true
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "‚úÖ Found: $doc"
          else
            echo "‚ùå Missing: $doc"
            all_found=false
          fi
        done
        
        if [ "$all_found" = false ]; then
          exit 1
        fi
        
    - name: Validate markdown links
      continue-on-error: true
      run: |
        echo "üîó Checking markdown files for broken links..."
        # Basic check for now - can be enhanced with markdown-link-check
        grep -r "](http" *.md docs/*.md || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run Bandit security scan
      continue-on-error: true
      run: |
        pip install bandit
        bandit -r cli/ adapters/ -f json -o bandit-report.json || true
        bandit -r cli/ adapters/ || true
        
    - name: Check for secrets
      run: |
        echo "üîí Checking for exposed secrets..."
        # Check for common secret patterns
        if grep -r "API_KEY\|api_key\|SECRET_KEY\|password.*=" --exclude-dir=.git --exclude="*.md" .; then
          echo "‚ö†Ô∏è  Warning: Potential secrets found in code"
        else
          echo "‚úÖ No obvious secrets detected"
        fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate-circuits, test-adapters, lint-python, validate-schema, build-docs]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "üéâ CI/CD Pipeline Summary"
        echo "========================="
        echo "‚úÖ All required checks completed"
        echo ""
        echo "Pipeline Status:"
        echo "  - Circuit Validation: ${{ needs.validate-circuits.result }}"
        echo "  - Adapter Tests: ${{ needs.test-adapters.result }}"
        echo "  - Python Linting: ${{ needs.lint-python.result }}"
        echo "  - Schema Validation: ${{ needs.validate-schema.result }}"
        echo "  - Documentation: ${{ needs.build-docs.result }}"
